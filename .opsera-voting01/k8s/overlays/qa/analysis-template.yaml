# ════════════════════════════════════════════════════════════════════════════════
# ANALYSIS TEMPLATE - QA Canary
# HTTP health check based (Prometheus disabled - not deployed)
# TTL cleanup: AnalysisRuns deleted after 5 min, Jobs deleted after 2 min
# ════════════════════════════════════════════════════════════════════════════════
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: voting01-health-check
  labels:
    app.kubernetes.io/name: voting01
    environment: qa
spec:
  # TTL Strategy - Clean up AnalysisRuns after completion
  ttlStrategy:
    secondsAfterCompletion: 300   # Delete successful AnalysisRuns after 5 minutes
    secondsAfterFailure: 600      # Keep failed ones longer for debugging (10 min)
  args:
    - name: service-name
    - name: namespace
  metrics:
    # HTTP health check - checks service responds with 200
    - name: http-health-check
      interval: 30s
      count: 5
      successCondition: result == "healthy"
      failureLimit: 2
      provider:
        job:
          spec:
            backoffLimit: 1
            ttlSecondsAfterFinished: 120  # Delete Job pods after 2 minutes
            template:
              spec:
                restartPolicy: Never
                containers:
                  - name: health-check
                    image: curlimages/curl:latest
                    command: ["/bin/sh", "-c"]
                    args:
                      - |
                        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://{{args.service-name}}.{{args.namespace}}.svc.cluster.local/" --max-time 10)
                        if [ "$HTTP_CODE" = "200" ]; then
                          echo "healthy"
                          exit 0
                        else
                          echo "unhealthy: HTTP $HTTP_CODE"
                          exit 1
                        fi
