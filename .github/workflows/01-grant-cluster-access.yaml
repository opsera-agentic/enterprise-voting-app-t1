# Grant Cluster Access to GitHub Actions Role
# This workflow adds the GitHub Actions IAM role to EKS cluster aws-auth ConfigMaps
#
# Supports: Hub cluster + Spoke clusters
# Prerequisites: The role running this workflow must already have access to target clusters
#
# Generated by Opsera Code-to-Cloud v0.6

name: "01-Grant Cluster Access"

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform"
        required: true
        default: "preview"
        type: choice
        options:
          - preview
          - apply
      clusters:
        description: "Which clusters to grant access to"
        required: true
        default: "all"
        type: choice
        options:
          - all           # Hub + all spokes
          - hub-only      # Only hub cluster
          - spokes-only   # Only spoke clusters

env:
  AWS_REGION: us-west-2
  HUB_CLUSTER: argocd-usw2
  SPOKE_NP: opsera-usw2-np
  SPOKE_PROD: opsera-usw2-prod
  APP_NAME: voting2
  ENVIRONMENT: dev

permissions:
  id-token: write
  contents: read

jobs:
  grant-access:
    name: "Grant Cluster Access"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/voting2-dev-github-actions
          role-session-name: github-actions-grant-access-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Grant Access to Clusters
        run: |
          ROLE_ARN="arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}-github-actions"
          USERNAME="github-actions-${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"
          ACTION="${{ github.event.inputs.action }}"
          CLUSTER_SELECTION="${{ github.event.inputs.clusters }}"

          echo "# Cluster Access Grant Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Role ARN**: \`${ROLE_ARN}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Username**: \`${USERNAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Action**: \`${ACTION}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Clusters**: \`${CLUSTER_SELECTION}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Build cluster list based on selection
          CLUSTERS=""
          if [ "$CLUSTER_SELECTION" == "all" ] || [ "$CLUSTER_SELECTION" == "hub-only" ]; then
            CLUSTERS="${{ env.HUB_CLUSTER }}"
          fi
          if [ "$CLUSTER_SELECTION" == "all" ] || [ "$CLUSTER_SELECTION" == "spokes-only" ]; then
            CLUSTERS="$CLUSTERS ${{ env.SPOKE_NP }} ${{ env.SPOKE_PROD }}"
          fi

          echo "## Cluster Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Cluster | Access | Role Status | Action |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-------------|--------|" >> $GITHUB_STEP_SUMMARY

          MANUAL_CLUSTERS=""

          for CLUSTER in $CLUSTERS; do
            echo ""
            echo "=========================================="
            echo "Processing cluster: $CLUSTER"
            echo "=========================================="

            # Try to connect to cluster
            aws eks update-kubeconfig --name "$CLUSTER" --region ${{ env.AWS_REGION }} 2>/dev/null || true

            # Test if we can access the cluster
            if kubectl get namespaces --request-timeout=10s >/dev/null 2>&1; then
              echo "âœ… Connected to $CLUSTER"

              # Check if role already exists
              if kubectl get configmap aws-auth -n kube-system -o yaml 2>/dev/null | grep -q "${ROLE_ARN}"; then
                echo "| \`$CLUSTER\` | âœ… Yes | âœ… Already configured | - |" >> $GITHUB_STEP_SUMMARY
                echo "Role already exists in $CLUSTER"
              else
                if [ "$ACTION" == "preview" ]; then
                  echo "| \`$CLUSTER\` | âœ… Yes | âš ï¸ Not configured | ðŸ” Preview |" >> $GITHUB_STEP_SUMMARY
                  echo "Would add role to $CLUSTER"
                else
                  # Apply the change
                  echo "Adding role to $CLUSTER aws-auth ConfigMap..."

                  # Get current mapRoles
                  CURRENT_MAP_ROLES=$(kubectl get configmap aws-auth -n kube-system -o jsonpath='{.data.mapRoles}')

                  # Create patch with new role appended
                  kubectl patch configmap aws-auth -n kube-system --type merge -p "$(cat <<PATCH
{
  "data": {
    "mapRoles": "${CURRENT_MAP_ROLES}\n- rolearn: ${ROLE_ARN}\n  username: ${USERNAME}\n  groups:\n    - system:masters\n"
  }
}
PATCH
)"
                  if [ $? -eq 0 ]; then
                    echo "| \`$CLUSTER\` | âœ… Yes | âœ… Added | âœ… Applied |" >> $GITHUB_STEP_SUMMARY
                    echo "âœ… Successfully added role to $CLUSTER"
                  else
                    echo "| \`$CLUSTER\` | âœ… Yes | âŒ Failed to add | âŒ Error |" >> $GITHUB_STEP_SUMMARY
                    echo "âŒ Failed to add role to $CLUSTER"
                  fi
                fi
              fi
            else
              echo "âŒ Cannot access $CLUSTER"
              echo "| \`$CLUSTER\` | âŒ No | - | ðŸ“‹ Manual required |" >> $GITHUB_STEP_SUMMARY
              MANUAL_CLUSTERS="$MANUAL_CLUSTERS $CLUSTER"
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY

          # Show manual instructions for inaccessible clusters
          if [ -n "$MANUAL_CLUSTERS" ]; then
            echo "## Manual Setup Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following clusters could not be accessed. Run these commands locally:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            for CLUSTER in $MANUAL_CLUSTERS; do
              echo "# Grant access to $CLUSTER" >> $GITHUB_STEP_SUMMARY
              echo "aws eks update-kubeconfig --name $CLUSTER --region ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
              echo "eksctl create iamidentitymapping \\" >> $GITHUB_STEP_SUMMARY
              echo "  --cluster $CLUSTER \\" >> $GITHUB_STEP_SUMMARY
              echo "  --region ${{ env.AWS_REGION }} \\" >> $GITHUB_STEP_SUMMARY
              echo "  --arn ${ROLE_ARN} \\" >> $GITHUB_STEP_SUMMARY
              echo "  --username ${USERNAME} \\" >> $GITHUB_STEP_SUMMARY
              echo "  --group system:masters" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            done
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$ACTION" == "preview" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "**To apply changes, re-run with action: \`apply\`**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Summary
        run: |
          echo ""
          echo "=========================================="
          echo "Grant Cluster Access Complete"
          echo "=========================================="
          echo "See workflow summary for details"
