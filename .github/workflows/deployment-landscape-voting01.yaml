# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# NEXT-GENERATION DEPLOYMENT LANDSCAPE REPORT - voting01
# Visual dashboard with architecture diagrams, hyperlinks, and status badges
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ğŸ“Š Landscape (voting01)"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'
  push:
    branches: [main]
    paths:
      - '.opsera-voting01/k8s/overlays/*/kustomization.yaml'

env:
  APP_NAME: voting01
  AWS_REGION: us-west-2
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np
  GITHUB_REPO: opsera-agentic/enterprise-voting-demo-only

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # COLLECT DATA
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  collect-data:
    name: "ğŸ“¦ Collect Data"
    runs-on: ubuntu-latest
    outputs:
      dev_version: ${{ steps.versions.outputs.dev }}
      qa_version: ${{ steps.versions.outputs.qa }}
      staging_version: ${{ steps.versions.outputs.staging }}
      in_sync: ${{ steps.versions.outputs.in_sync }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract Versions
        id: versions
        run: |
          DEV=$(grep -A2 'PLACEHOLDER_VOTE' .opsera-voting01/k8s/overlays/dev/kustomization.yaml | grep newTag | awk '{print $2}' || echo "unknown")
          QA=$(grep -A2 'PLACEHOLDER_VOTE' .opsera-voting01/k8s/overlays/qa/kustomization.yaml | grep newTag | awk '{print $2}' || echo "unknown")
          STAGING=$(grep -A2 'PLACEHOLDER_VOTE' .opsera-voting01/k8s/overlays/staging/kustomization.yaml | grep newTag | awk '{print $2}' || echo "unknown")

          echo "dev=${DEV}" >> $GITHUB_OUTPUT
          echo "qa=${QA}" >> $GITHUB_OUTPUT
          echo "staging=${STAGING}" >> $GITHUB_OUTPUT

          if [ "$DEV" == "$QA" ] && [ "$QA" == "$STAGING" ]; then
            echo "in_sync=true" >> $GITHUB_OUTPUT
          else
            echo "in_sync=false" >> $GITHUB_OUTPUT
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # COLLECT CLUSTER METRICS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  collect-metrics:
    name: "ğŸ“Š Collect Metrics"
    runs-on: ubuntu-latest
    outputs:
      dev_pods: ${{ steps.metrics.outputs.dev_pods }}
      qa_pods: ${{ steps.metrics.outputs.qa_pods }}
      staging_pods: ${{ steps.metrics.outputs.staging_pods }}
      dev_health: ${{ steps.metrics.outputs.dev_health }}
      qa_health: ${{ steps.metrics.outputs.qa_health }}
      staging_health: ${{ steps.metrics.outputs.staging_health }}
    steps:
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Get Cluster Metrics
        id: metrics
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }} 2>/dev/null || true

          for ENV in dev qa staging; do
            NS="${{ env.APP_NAME }}-${ENV}"
            PODS=$(kubectl get pods -n $NS --no-headers 2>/dev/null | grep -c Running || echo "0")
            READY=$(kubectl get pods -n $NS --no-headers 2>/dev/null | grep -c "1/1\|2/2\|3/3" || echo "0")
            echo "${ENV}_pods=${PODS}" >> $GITHUB_OUTPUT
            if [ "$PODS" -gt 0 ] && [ "$READY" -eq "$PODS" ]; then
              echo "${ENV}_health=healthy" >> $GITHUB_OUTPUT
            elif [ "$PODS" -gt 0 ]; then
              echo "${ENV}_health=degraded" >> $GITHUB_OUTPUT
            else
              echo "${ENV}_health=unknown" >> $GITHUB_OUTPUT
            fi
          done

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # GENERATE REPORT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  generate-report:
    name: "ğŸ“Š Generate Report"
    needs: [collect-data, collect-metrics]
    runs-on: ubuntu-latest
    steps:
      - name: Report Header
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          <div align="center">

          # ğŸš€ DEPLOYMENT LANDSCAPE
          ### voting01 | Enterprise Voting Application

          </div>

          ---

          EOF

      - name: Sync Status Banner
        env:
          IN_SYNC: ${{ needs.collect-data.outputs.in_sync }}
          VERSION: ${{ needs.collect-data.outputs.dev_version }}
        run: |
          if [ "$IN_SYNC" == "true" ]; then
            echo "> âœ… **ALL ENVIRONMENTS SYNCHRONIZED** - Version \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "> âš ï¸ **ENVIRONMENTS OUT OF SYNC** - Review versions below" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Architecture Diagram
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          ## ğŸ—ï¸ Architecture

          ```mermaid
          flowchart LR
              subgraph GH["GitHub"]
                  REPO[("ğŸ“¦ Source")]
                  CI["âš™ï¸ Actions"]
              end

              subgraph AWS["AWS us-west-2"]
                  ECR["ğŸ³ ECR"]
                  subgraph EKS["EKS Clusters"]
                      HUB["ğŸ¯ ArgoCD Hub"]
                      SPOKE["ğŸ¡ Workloads"]
                  end
              end

              subgraph ENVS["Environments"]
                  DEV["ğŸ”§ DEV"]
                  QA["ğŸ§ª QA"]
                  STG["ğŸ­ Staging"]
              end

              NR["ğŸ“Š New Relic"]

              REPO --> CI --> ECR --> HUB --> SPOKE
              SPOKE --> DEV & QA & STG
              DEV & QA & STG --> NR
          ```

          EOF

      - name: Environment Status Table
        env:
          DEV_V: ${{ needs.collect-data.outputs.dev_version }}
          QA_V: ${{ needs.collect-data.outputs.qa_version }}
          STG_V: ${{ needs.collect-data.outputs.staging_version }}
          DEV_P: ${{ needs.collect-metrics.outputs.dev_pods }}
          QA_P: ${{ needs.collect-metrics.outputs.qa_pods }}
          STG_P: ${{ needs.collect-metrics.outputs.staging_pods }}
          DEV_H: ${{ needs.collect-metrics.outputs.dev_health }}
          QA_H: ${{ needs.collect-metrics.outputs.qa_health }}
          STG_H: ${{ needs.collect-metrics.outputs.staging_health }}
          REPO_URL: https://github.com/${{ env.GITHUB_REPO }}
        run: |
          health_icon() {
            case "$1" in
              healthy) echo "âœ…" ;;
              degraded) echo "âš ï¸" ;;
              *) echo "â“" ;;
            esac
          }

          # Extract commit SHA from version (format: commitsha-timestamp)
          version_link() {
            local version=$1
            if [ "$version" != "unknown" ] && [ -n "$version" ]; then
              local sha=$(echo "$version" | cut -d'-' -f1)
              echo "[\`${version}\`](${REPO_URL}/commit/${sha})"
            else
              echo "\`${version}\`"
            fi
          }

          echo "## ğŸŒ Environment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Version | Pods | Health | Strategy |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|---------|------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”§ **DEV** | $(version_link "$DEV_V") | ${DEV_P:-0} | $(health_icon $DEV_H) | Rolling |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§ª **QA** | $(version_link "$QA_V") | ${QA_P:-0} | $(health_icon $QA_H) | ğŸ¤ Canary |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ­ **STAGING** | $(version_link "$STG_V") | ${STG_P:-0} | $(health_icon $STG_H) | ğŸ”µğŸŸ¢ Blue-Green |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Quick Links
        run: |
          REPO="https://github.com/${{ env.GITHUB_REPO }}"
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## ğŸ”— Quick Links

          ### ğŸ“‚ Source Code
          | Service | Code | Dockerfile | K8s Base |
          |---------|------|------------|----------|
          | ğŸ—³ï¸ Vote | [vote/](${REPO}/tree/main/vote) | [Dockerfile](${REPO}/blob/main/.opsera-voting01/Dockerfiles/Dockerfile.vote) | [deployment](${REPO}/blob/main/.opsera-voting01/k8s/base/vote-deployment.yaml) |
          | ğŸ“Š Result | [result/](${REPO}/tree/main/result) | [Dockerfile](${REPO}/blob/main/.opsera-voting01/Dockerfiles/Dockerfile.result) | [deployment](${REPO}/blob/main/.opsera-voting01/k8s/base/result-deployment.yaml) |
          | âš™ï¸ Worker | [worker/](${REPO}/tree/main/worker) | [Dockerfile](${REPO}/blob/main/.opsera-voting01/Dockerfiles/Dockerfile.worker) | [deployment](${REPO}/blob/main/.opsera-voting01/k8s/base/worker-deployment.yaml) |

          ### ğŸ”§ Environment Configs
          | Environment | Kustomization | ConfigMap |
          |-------------|---------------|-----------|
          | DEV | [overlays/dev](${REPO}/tree/main/.opsera-voting01/k8s/overlays/dev) | [configmap](${REPO}/blob/main/.opsera-voting01/k8s/overlays/dev/configmap.yaml) |
          | QA | [overlays/qa](${REPO}/tree/main/.opsera-voting01/k8s/overlays/qa) | [configmap](${REPO}/blob/main/.opsera-voting01/k8s/overlays/qa/configmap.yaml) |
          | Staging | [overlays/staging](${REPO}/tree/main/.opsera-voting01/k8s/overlays/staging) | [configmap](${REPO}/blob/main/.opsera-voting01/k8s/overlays/staging/configmap.yaml) |

          EOF

      - name: CI/CD Workflows
        run: |
          REPO="https://github.com/${{ env.GITHUB_REPO }}"
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ### âš™ï¸ CI/CD Workflows
          | Workflow | Trigger | Actions |
          |----------|---------|---------|
          | [CI Build DEV](${REPO}/actions/workflows/ci-build-push-voting01-dev.yaml) | Push to main | [â–¶ï¸ Run](${REPO}/actions/workflows/ci-build-push-voting01-dev.yaml) |
          | [CI Build QA](${REPO}/actions/workflows/ci-build-push-voting01-qa.yaml) | Manual | [â–¶ï¸ Run](${REPO}/actions/workflows/ci-build-push-voting01-qa.yaml) |
          | [CI Build Staging](${REPO}/actions/workflows/ci-build-push-voting01-staging.yaml) | Manual | [â–¶ï¸ Run](${REPO}/actions/workflows/ci-build-push-voting01-staging.yaml) |
          | [Promote](${REPO}/actions/workflows/promote-voting01.yaml) | Manual | [â–¶ï¸ Run](${REPO}/actions/workflows/promote-voting01.yaml) |
          | [Diagnostics](${REPO}/actions/workflows/diagnostics-voting01.yaml) | Manual | [â–¶ï¸ Run](${REPO}/actions/workflows/diagnostics-voting01.yaml) |

          EOF

      - name: Live Endpoints
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          ### ğŸŒ Live Endpoints
          | Environment | Vote App | Result App |
          |-------------|----------|------------|
          | ğŸ”§ DEV | [vote-voting01-dev.agent.opsera.dev](https://vote-voting01-dev.agent.opsera.dev) | [result-voting01-dev.agent.opsera.dev](https://result-voting01-dev.agent.opsera.dev) |
          | ğŸ§ª QA | [vote-voting01-qa.agent.opsera.dev](https://vote-voting01-qa.agent.opsera.dev) | [result-voting01-qa.agent.opsera.dev](https://result-voting01-qa.agent.opsera.dev) |
          | ğŸ­ Staging | [vote-voting01-staging.agent.opsera.dev](https://vote-voting01-staging.agent.opsera.dev) | [result-voting01-staging.agent.opsera.dev](https://result-voting01-staging.agent.opsera.dev) |

          EOF

      - name: Observability
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          ## ğŸ“Š Observability

          ### New Relic APM
          | Environment | Vote | Result | Worker |
          |-------------|------|--------|--------|
          | DEV | voting01-vote-dev | voting01-result-dev | voting01-worker-dev |
          | QA | voting01-vote-qa | voting01-result-qa | voting01-worker-qa |
          | Staging | voting01-vote-staging | voting01-result-staging | voting01-worker-staging |

          ğŸ”— [Open New Relic Dashboard](https://one.newrelic.com)

          EOF

      - name: Infrastructure
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          ## â˜ï¸ Infrastructure

          | Resource | Details | Console |
          |----------|---------|---------|
          | ğŸ³ ECR Registry | `792373136340.dkr.ecr.us-west-2.amazonaws.com/opsera/` | [AWS Console](https://us-west-2.console.aws.amazon.com/ecr/repositories?region=us-west-2) |
          | ğŸ¯ Hub Cluster | `argocd-usw2` | [EKS Console](https://us-west-2.console.aws.amazon.com/eks/home?region=us-west-2#/clusters/argocd-usw2) |
          | ğŸ¡ Spoke Cluster | `opsera-usw2-np` | [EKS Console](https://us-west-2.console.aws.amazon.com/eks/home?region=us-west-2#/clusters/opsera-usw2-np) |
          | ğŸ”„ ArgoCD | GitOps Controller | [ArgoCD Dashboard](https://argocd.agent.opsera.dev) |

          EOF

      - name: Promotion Flow
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          ## ğŸš€ Promotion Flow

          ```mermaid
          flowchart LR
              DEV["ğŸ”§ DEV<br/>Auto-deploy on push"]
              QA["ğŸ§ª QA<br/>Manual trigger<br/>ğŸ¤ Canary 10â†’30â†’60â†’100%"]
              STG["ğŸ­ STAGING<br/>Approval required<br/>ğŸ”µğŸŸ¢ Blue-Green"]
              PROD["ğŸ­ PRODUCTION<br/>Coming Soon"]

              DEV -->|"promote"| QA -->|"approve"| STG -.->|"future"| PROD
          ```

          EOF

      - name: Report Footer
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          ---

          <div align="center">

          **Powered by [Opsera](https://opsera.io)** - The Unified DevOps Platform

          ğŸ“… Generated: $(date -u +'%Y-%m-%d %H:%M UTC') | [ğŸ”„ Refresh](https://github.com/${{ env.GITHUB_REPO }}/actions/workflows/deployment-landscape-voting01.yaml)

          </div>
          EOF

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # NOTIFY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  notify:
    name: "ğŸ“¢ Notify"
    needs: [generate-report]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Slack Notification
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "Slack webhook not configured, skipping notification"
            exit 0
          fi
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "text": "ğŸ“Š Deployment Landscape Report Updated",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸ“Š *Deployment Landscape Report* has been updated for `voting01`\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Full Report>"
                  }
                }
              ]
            }' || true
