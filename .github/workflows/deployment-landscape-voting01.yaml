# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# NEXT-GENERATION DEPLOYMENT LANDSCAPE REPORT - voting01
# Visual dashboard with architecture diagrams, hyperlinks, and status badges
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ğŸ“Š Landscape (voting01)"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'
  push:
    branches: [main]
    paths:
      - '.opsera-voting01/k8s/overlays/*/kustomization.yaml'

env:
  APP_NAME: voting01
  AWS_REGION: us-west-2
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np
  GITHUB_REPO: opsera-agentic/enterprise-voting-demo-only

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # COLLECT DATA
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  collect-data:
    name: "ğŸ“¦ Collect Data"
    runs-on: ubuntu-latest
    outputs:
      dev_version: ${{ steps.versions.outputs.dev }}
      qa_version: ${{ steps.versions.outputs.qa }}
      staging_version: ${{ steps.versions.outputs.staging }}
      in_sync: ${{ steps.versions.outputs.in_sync }}
      dev_history: ${{ steps.history.outputs.dev_history }}
      qa_history: ${{ steps.history.outputs.qa_history }}
      staging_history: ${{ steps.history.outputs.staging_history }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract Versions
        id: versions
        run: |
          DEV=$(grep -A2 'PLACEHOLDER_VOTE' .opsera-voting01/k8s/overlays/dev/kustomization.yaml | grep newTag | awk '{print $2}' || echo "unknown")
          QA=$(grep -A2 'PLACEHOLDER_VOTE' .opsera-voting01/k8s/overlays/qa/kustomization.yaml | grep newTag | awk '{print $2}' || echo "unknown")
          STAGING=$(grep -A2 'PLACEHOLDER_VOTE' .opsera-voting01/k8s/overlays/staging/kustomization.yaml | grep newTag | awk '{print $2}' || echo "unknown")

          echo "dev=${DEV}" >> $GITHUB_OUTPUT
          echo "qa=${QA}" >> $GITHUB_OUTPUT
          echo "staging=${STAGING}" >> $GITHUB_OUTPUT

          if [ "$DEV" == "$QA" ] && [ "$QA" == "$STAGING" ]; then
            echo "in_sync=true" >> $GITHUB_OUTPUT
          else
            echo "in_sync=false" >> $GITHUB_OUTPUT
          fi

      - name: Collect Deployment History
        id: history
        run: |
          # Function to get deployment history for an environment
          # Format: SHA~TAG~TIMESTAMP~AUTHOR (uses ~ as field separator, ; as record separator)
          get_history() {
            local env=$1
            git log --oneline --grep="deploy(voting01-${env}):" --format="%H|%s|%ct|%an" -n 5 2>/dev/null | while read line; do
              if [ -n "$line" ]; then
                SHA=$(echo "$line" | cut -d'|' -f1)
                SHORT_SHA=$(echo "$SHA" | cut -c1-7)
                MSG=$(echo "$line" | cut -d'|' -f2 | sed 's/deploy(voting01-'${env}'): //' | sed 's/ \[skip ci\]//')
                TIMESTAMP=$(echo "$line" | cut -d'|' -f3)
                AUTHOR=$(echo "$line" | cut -d'|' -f4)
                echo "${SHORT_SHA}~${MSG}~${TIMESTAMP}~${AUTHOR}"
              fi
            done | tr '\n' ';' | sed 's/;$//'
          }

          DEV_HIST=$(get_history "dev")
          QA_HIST=$(get_history "qa")
          STAGING_HIST=$(get_history "staging")

          echo "dev_history=${DEV_HIST}" >> $GITHUB_OUTPUT
          echo "qa_history=${QA_HIST}" >> $GITHUB_OUTPUT
          echo "staging_history=${STAGING_HIST}" >> $GITHUB_OUTPUT

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # COLLECT CLUSTER METRICS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  collect-metrics:
    name: "ğŸ“Š Collect Metrics"
    runs-on: ubuntu-latest
    outputs:
      dev_pods: ${{ steps.metrics.outputs.dev_pods }}
      qa_pods: ${{ steps.metrics.outputs.qa_pods }}
      staging_pods: ${{ steps.metrics.outputs.staging_pods }}
      dev_health: ${{ steps.metrics.outputs.dev_health }}
      qa_health: ${{ steps.metrics.outputs.qa_health }}
      staging_health: ${{ steps.metrics.outputs.staging_health }}
    steps:
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Get Cluster Metrics
        id: metrics
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }} 2>/dev/null || true

          for ENV in dev qa staging; do
            NS="${{ env.APP_NAME }}-${ENV}"
            PODS=$(kubectl get pods -n $NS --no-headers 2>/dev/null | grep -c Running || echo "0")
            READY=$(kubectl get pods -n $NS --no-headers 2>/dev/null | grep -c "1/1\|2/2\|3/3" || echo "0")
            echo "${ENV}_pods=${PODS}" >> $GITHUB_OUTPUT
            if [ "$PODS" -gt 0 ] && [ "$READY" -eq "$PODS" ]; then
              echo "${ENV}_health=healthy" >> $GITHUB_OUTPUT
            elif [ "$PODS" -gt 0 ]; then
              echo "${ENV}_health=degraded" >> $GITHUB_OUTPUT
            else
              echo "${ENV}_health=unknown" >> $GITHUB_OUTPUT
            fi
          done

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # GENERATE REPORT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  generate-report:
    name: "ğŸ“Š Generate Report"
    needs: [collect-data, collect-metrics]
    runs-on: ubuntu-latest
    steps:
      - name: Report Header
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          <div align="center">

          # ğŸš€ DEPLOYMENT LANDSCAPE
          ### voting01 | Enterprise Voting Application

          </div>

          ---

          EOF

      - name: Sync Status Banner
        env:
          IN_SYNC: ${{ needs.collect-data.outputs.in_sync }}
          VERSION: ${{ needs.collect-data.outputs.dev_version }}
        run: |
          if [ "$IN_SYNC" == "true" ]; then
            echo "> âœ… **ALL ENVIRONMENTS SYNCHRONIZED** - Version \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "> âš ï¸ **ENVIRONMENTS OUT OF SYNC** - Review versions below" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Application Architecture
        env:
          REPO_URL: https://github.com/${{ env.GITHUB_REPO }}
        run: |
          cat << 'MERMAID' >> $GITHUB_STEP_SUMMARY
          ## ğŸ—³ï¸ Application Architecture

          ```mermaid
          flowchart TB
              subgraph FRONTEND["Frontend Layer"]
                  VOTE["ğŸ—³ï¸ Vote<br/>Python Flask<br/>Port 80"]
                  RESULT["ğŸ“Š Result<br/>Node.js + Socket.io<br/>Port 80"]
              end

              subgraph BACKEND["Backend Layer"]
                  WORKER["âš™ï¸ Worker<br/>.NET Core<br/>Background Process"]
              end

              subgraph DATA["Data Layer"]
                  REDIS[("ğŸ”´ Redis<br/>Vote Queue<br/>ElastiCache")]
                  POSTGRES[("ğŸ˜ PostgreSQL<br/>Vote Storage<br/>RDS")]
              end

              USER((ğŸ‘¤ User)) --> VOTE
              USER --> RESULT
              VOTE -->|"Submit Vote"| REDIS
              WORKER -->|"Read Votes"| REDIS
              WORKER -->|"Persist Votes"| POSTGRES
              RESULT -->|"Query Results"| POSTGRES
          ```

          ### Service Details
          MERMAID
          echo "| Service | Language | Source | Dockerfile | Purpose |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|----------|--------|------------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ—³ï¸ Vote | Python 3.9 | [vote/](${REPO_URL}/tree/main/vote) | [Dockerfile.vote](${REPO_URL}/blob/main/.opsera-voting01/Dockerfiles/Dockerfile.vote) | Web UI for casting votes |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“Š Result | Node.js 18 | [result/](${REPO_URL}/tree/main/result) | [Dockerfile.result](${REPO_URL}/blob/main/.opsera-voting01/Dockerfiles/Dockerfile.result) | Real-time results dashboard |" >> $GITHUB_STEP_SUMMARY
          echo "| âš™ï¸ Worker | .NET 7 | [worker/](${REPO_URL}/tree/main/worker) | [Dockerfile.worker](${REPO_URL}/blob/main/.opsera-voting01/Dockerfiles/Dockerfile.worker) | Background vote processor |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Infrastructure Architecture
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          ## ğŸ—ï¸ Infrastructure Architecture

          ```mermaid
          flowchart LR
              subgraph GH["GitHub"]
                  REPO[("ğŸ“¦ Source")]
                  CI["âš™ï¸ Actions"]
              end

              subgraph AWS["AWS us-west-2"]
                  ECR["ğŸ³ ECR"]
                  subgraph EKS["EKS Clusters"]
                      HUB["ğŸ¯ ArgoCD Hub"]
                      SPOKE["ğŸ¡ Workloads"]
                  end
              end

              subgraph ENVS["Environments"]
                  DEV["ğŸ”§ DEV"]
                  QA["ğŸ§ª QA"]
                  STG["ğŸ­ Staging"]
              end

              NR["ğŸ“Š New Relic"]

              REPO --> CI --> ECR --> HUB --> SPOKE
              SPOKE --> DEV & QA & STG
              DEV & QA & STG --> NR
          ```

          EOF

      - name: CI/CD Pipeline Flow
        env:
          REPO_URL: https://github.com/${{ env.GITHUB_REPO }}
        run: |
          cat << 'MERMAID' >> $GITHUB_STEP_SUMMARY
          ## ğŸ”„ CI/CD Pipeline Flow

          ### DEV Pipeline (Auto-trigger on push)
          ```mermaid
          flowchart LR
              subgraph TRIGGER["Trigger"]
                  PUSH["ğŸ“¥ Push to main"]
              end

              subgraph SCAN["Security & Quality"]
                  SEC["ğŸ”’ Gitleaks<br/>Secret Scan"]
                  SONAR["ğŸ“Š SonarQube<br/>Code Quality"]
              end

              subgraph BUILD["Build & Scan"]
                  B1["ğŸ—ï¸ Build Vote"]
                  B2["ğŸ—ï¸ Build Result"]
                  B3["ğŸ—ï¸ Build Worker"]
                  G1["ğŸ›¡ï¸ Grype Scan"]
              end

              subgraph DEPLOY["Deploy"]
                  ECR["ğŸ“¦ Push ECR"]
                  KUST["ğŸ“ Update Kustomize"]
                  ARGO["ğŸ”„ ArgoCD Sync"]
              end

              subgraph NOTIFY["Notifications"]
                  SLACK["ğŸ“¢ Slack"]
                  JIRA["ğŸ“‹ Jira"]
              end

              PUSH --> SEC & SONAR
              SEC & SONAR --> B1 & B2 & B3
              B1 & B2 & B3 --> G1
              G1 --> ECR --> KUST --> ARGO
              ARGO --> SLACK & JIRA
          ```

          ### Environment Promotion
          ```mermaid
          flowchart LR
              subgraph DEV["ğŸ”§ DEV Environment"]
                  D1["CI Build DEV"]
                  D2["Rolling Deploy"]
              end

              subgraph QA["ğŸ§ª QA Environment"]
                  Q1["CI Build QA"]
                  Q2["ğŸ¤ Canary Deploy<br/>10% â†’ 30% â†’ 60% â†’ 100%"]
                  Q3["APM Analysis"]
              end

              subgraph STG["ğŸ­ Staging Environment"]
                  S1["CI Build Staging"]
                  S2["ğŸ”µğŸŸ¢ Blue-Green<br/>Preview URL"]
                  S3["Traffic Switch"]
              end

              D1 --> D2
              D2 -->|"Manual Promote"| Q1
              Q1 --> Q2 --> Q3
              Q3 -->|"Approval Gate"| S1
              S1 --> S2 --> S3
          ```

          ### Workflow Files
          MERMAID
          echo "| Pipeline | File | Trigger | Strategy |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|---------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| DEV CI/CD | [ci-build-push-voting01-dev.yaml](${REPO_URL}/blob/main/.github/workflows/ci-build-push-voting01-dev.yaml) | Push to main | Rolling |" >> $GITHUB_STEP_SUMMARY
          echo "| QA CI/CD | [ci-build-push-voting01-qa.yaml](${REPO_URL}/blob/main/.github/workflows/ci-build-push-voting01-qa.yaml) | Manual / Dispatch | Canary |" >> $GITHUB_STEP_SUMMARY
          echo "| Staging CI/CD | [ci-build-push-voting01-staging.yaml](${REPO_URL}/blob/main/.github/workflows/ci-build-push-voting01-staging.yaml) | Manual / Dispatch | Blue-Green |" >> $GITHUB_STEP_SUMMARY
          echo "| Promotion | [promote-voting01.yaml](${REPO_URL}/blob/main/.github/workflows/promote-voting01.yaml) | Manual | Health Check + Dispatch |" >> $GITHUB_STEP_SUMMARY
          echo "| Bootstrap | [00-bootstrap-infrastructure-voting01.yaml](${REPO_URL}/blob/main/.github/workflows/00-bootstrap-infrastructure-voting01.yaml) | Manual | Terraform + ArgoCD |" >> $GITHUB_STEP_SUMMARY
          echo "| Landscape | [deployment-landscape-voting01.yaml](${REPO_URL}/blob/main/.github/workflows/deployment-landscape-voting01.yaml) | Schedule / Push | Report Only |" >> $GITHUB_STEP_SUMMARY
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY

          ### Pipeline Jobs Detail
          | Job | Purpose | Blocking | Outputs |
          |-----|---------|----------|---------|
          | ğŸ”’ Security Scan | Gitleaks secret detection | configurable | - |
          | ğŸ“Š SonarQube | Code quality analysis | configurable | quality_gate_status |
          | ğŸ—ï¸ Build & Push | Docker build + Grype scan + ECR push | yes | image_tag, vulnerabilities |
          | ğŸš€ Deploy | Kustomize update + ArgoCD sync | yes | success status |
          | ğŸ“¢ Slack | Pipeline notifications | no | - |
          | ğŸ“‹ Jira | Issue creation on failure | no | issue_key |

          EOF

      - name: Environment Status Table
        env:
          DEV_V: ${{ needs.collect-data.outputs.dev_version }}
          QA_V: ${{ needs.collect-data.outputs.qa_version }}
          STG_V: ${{ needs.collect-data.outputs.staging_version }}
          DEV_P: ${{ needs.collect-metrics.outputs.dev_pods }}
          QA_P: ${{ needs.collect-metrics.outputs.qa_pods }}
          STG_P: ${{ needs.collect-metrics.outputs.staging_pods }}
          DEV_H: ${{ needs.collect-metrics.outputs.dev_health }}
          QA_H: ${{ needs.collect-metrics.outputs.qa_health }}
          STG_H: ${{ needs.collect-metrics.outputs.staging_health }}
          REPO_URL: https://github.com/${{ env.GITHUB_REPO }}
        run: |
          health_icon() {
            case "$1" in
              healthy) echo "âœ…" ;;
              degraded) echo "âš ï¸" ;;
              *) echo "â“" ;;
            esac
          }

          # Extract commit SHA from version (format: commitsha-timestamp)
          version_link() {
            local version=$1
            if [ "$version" != "unknown" ] && [ -n "$version" ]; then
              local sha=$(echo "$version" | cut -d'-' -f1)
              echo "[\`${version}\`](${REPO_URL}/commit/${sha})"
            else
              echo "\`${version}\`"
            fi
          }

          echo "## ğŸŒ Environment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Version | Pods | Health | Strategy |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|---------|------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”§ **DEV** | $(version_link "$DEV_V") | ${DEV_P:-0} | $(health_icon $DEV_H) | Rolling |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§ª **QA** | $(version_link "$QA_V") | ${QA_P:-0} | $(health_icon $QA_H) | ğŸ¤ Canary |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ­ **STAGING** | $(version_link "$STG_V") | ${STG_P:-0} | $(health_icon $STG_H) | ğŸ”µğŸŸ¢ Blue-Green |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Deployment History
        env:
          DEV_HIST: ${{ needs.collect-data.outputs.dev_history }}
          QA_HIST: ${{ needs.collect-data.outputs.qa_history }}
          STG_HIST: ${{ needs.collect-data.outputs.staging_history }}
          REPO_URL: https://github.com/${{ env.GITHUB_REPO }}
        run: |
          echo "## ğŸ“œ Deployment History (Last 5)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Function to convert timestamp to relative time
          relative_time() {
            local timestamp=$1
            local now=$(date +%s)
            local diff=$((now - timestamp))

            if [ $diff -lt 60 ]; then
              echo "just now"
            elif [ $diff -lt 3600 ]; then
              local mins=$((diff / 60))
              [ $mins -eq 1 ] && echo "1 min ago" || echo "${mins} mins ago"
            elif [ $diff -lt 86400 ]; then
              local hrs=$((diff / 3600))
              [ $hrs -eq 1 ] && echo "1 hr ago" || echo "${hrs} hrs ago"
            elif [ $diff -lt 604800 ]; then
              local days=$((diff / 86400))
              [ $days -eq 1 ] && echo "1 day ago" || echo "${days} days ago"
            else
              local weeks=$((diff / 604800))
              [ $weeks -eq 1 ] && echo "1 week ago" || echo "${weeks} weeks ago"
            fi
          }

          # Function to render deployment history table
          # Format: SHA~TAG~TIMESTAMP~AUTHOR
          render_history() {
            local env_name=$1
            local env_icon=$2
            local history=$3

            echo "#### ${env_icon} ${env_name}" >> $GITHUB_STEP_SUMMARY
            echo "| # | Commit | Image Tag | Deployed By | When |" >> $GITHUB_STEP_SUMMARY
            echo "|---|--------|-----------|-------------|------|" >> $GITHUB_STEP_SUMMARY

            if [ -z "$history" ]; then
              echo "| - | No deployments found | - | - | - |" >> $GITHUB_STEP_SUMMARY
            else
              count=1
              IFS=';' read -ra ENTRIES <<< "$history"
              for entry in "${ENTRIES[@]}"; do
                if [ -n "$entry" ]; then
                  SHA=$(echo "$entry" | cut -d'~' -f1)
                  TAG=$(echo "$entry" | cut -d'~' -f2)
                  TIMESTAMP=$(echo "$entry" | cut -d'~' -f3)
                  AUTHOR=$(echo "$entry" | cut -d'~' -f4)
                  REL_TIME=$(relative_time "$TIMESTAMP")
                  echo "| ${count} | [\`${SHA}\`](${REPO_URL}/commit/${SHA}) | \`${TAG}\` | ${AUTHOR} | ${REL_TIME} |" >> $GITHUB_STEP_SUMMARY
                  count=$((count + 1))
                fi
              done
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          }

          render_history "DEV" "ğŸ”§" "$DEV_HIST"
          render_history "QA" "ğŸ§ª" "$QA_HIST"
          render_history "STAGING" "ğŸ­" "$STG_HIST"

      - name: Quick Links
        env:
          REPO_URL: https://github.com/${{ env.GITHUB_REPO }}
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          ## ğŸ”— Quick Links

          ### ğŸ”§ Kubernetes Manifests
          EOF
          echo "| Environment | Kustomization | ConfigMap | Deployment Base |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|---------------|-----------|-----------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Base | [k8s/base](${REPO_URL}/tree/main/.opsera-voting01/k8s/base) | - | [vote](${REPO_URL}/blob/main/.opsera-voting01/k8s/base/vote-deployment.yaml) / [result](${REPO_URL}/blob/main/.opsera-voting01/k8s/base/result-deployment.yaml) / [worker](${REPO_URL}/blob/main/.opsera-voting01/k8s/base/worker-deployment.yaml) |" >> $GITHUB_STEP_SUMMARY
          echo "| DEV | [overlays/dev](${REPO_URL}/tree/main/.opsera-voting01/k8s/overlays/dev) | [configmap](${REPO_URL}/blob/main/.opsera-voting01/k8s/overlays/dev/configmap.yaml) | [kustomization](${REPO_URL}/blob/main/.opsera-voting01/k8s/overlays/dev/kustomization.yaml) |" >> $GITHUB_STEP_SUMMARY
          echo "| QA | [overlays/qa](${REPO_URL}/tree/main/.opsera-voting01/k8s/overlays/qa) | [configmap](${REPO_URL}/blob/main/.opsera-voting01/k8s/overlays/qa/configmap.yaml) | [kustomization](${REPO_URL}/blob/main/.opsera-voting01/k8s/overlays/qa/kustomization.yaml) |" >> $GITHUB_STEP_SUMMARY
          echo "| Staging | [overlays/staging](${REPO_URL}/tree/main/.opsera-voting01/k8s/overlays/staging) | [configmap](${REPO_URL}/blob/main/.opsera-voting01/k8s/overlays/staging/configmap.yaml) | [kustomization](${REPO_URL}/blob/main/.opsera-voting01/k8s/overlays/staging/kustomization.yaml) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â–¶ï¸ Run Workflows" >> $GITHUB_STEP_SUMMARY
          echo "| Action | Link |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”§ Deploy to DEV | [â–¶ï¸ Run CI Build DEV](${REPO_URL}/actions/workflows/ci-build-push-voting01-dev.yaml) |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§ª Deploy to QA | [â–¶ï¸ Run CI Build QA](${REPO_URL}/actions/workflows/ci-build-push-voting01-qa.yaml) |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ­ Deploy to Staging | [â–¶ï¸ Run CI Build Staging](${REPO_URL}/actions/workflows/ci-build-push-voting01-staging.yaml) |" >> $GITHUB_STEP_SUMMARY
          echo "| â¬†ï¸ Promote Environment | [â–¶ï¸ Run Promotion](${REPO_URL}/actions/workflows/promote-voting01.yaml) |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Run Diagnostics | [â–¶ï¸ Run Diagnostics](${REPO_URL}/actions/workflows/diagnostics-voting01.yaml) |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“Š Refresh Landscape | [â–¶ï¸ Run Landscape](${REPO_URL}/actions/workflows/deployment-landscape-voting01.yaml) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Live Endpoints
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          ### ğŸŒ Live Endpoints
          | Environment | Vote App | Result App |
          |-------------|----------|------------|
          | ğŸ”§ DEV | [vote-voting01-dev.agent.opsera.dev](https://vote-voting01-dev.agent.opsera.dev) | [result-voting01-dev.agent.opsera.dev](https://result-voting01-dev.agent.opsera.dev) |
          | ğŸ§ª QA | [vote-voting01-qa.agent.opsera.dev](https://vote-voting01-qa.agent.opsera.dev) | [result-voting01-qa.agent.opsera.dev](https://result-voting01-qa.agent.opsera.dev) |
          | ğŸ­ Staging | [vote-voting01-staging.agent.opsera.dev](https://vote-voting01-staging.agent.opsera.dev) | [result-voting01-staging.agent.opsera.dev](https://result-voting01-staging.agent.opsera.dev) |

          EOF

      - name: Observability
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          ## ğŸ“Š Observability

          ### New Relic APM
          | Environment | Vote | Result | Worker |
          |-------------|------|--------|--------|
          | DEV | voting01-vote-dev | voting01-result-dev | voting01-worker-dev |
          | QA | voting01-vote-qa | voting01-result-qa | voting01-worker-qa |
          | Staging | voting01-vote-staging | voting01-result-staging | voting01-worker-staging |

          ğŸ”— [Open New Relic Dashboard](https://one.newrelic.com)

          EOF

      - name: Infrastructure
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          ## â˜ï¸ Infrastructure

          | Resource | Details | Console |
          |----------|---------|---------|
          | ğŸ³ ECR Registry | `792373136340.dkr.ecr.us-west-2.amazonaws.com/opsera/` | [AWS Console](https://us-west-2.console.aws.amazon.com/ecr/repositories?region=us-west-2) |
          | ğŸ¯ Hub Cluster | `argocd-usw2` | [EKS Console](https://us-west-2.console.aws.amazon.com/eks/home?region=us-west-2#/clusters/argocd-usw2) |
          | ğŸ¡ Spoke Cluster | `opsera-usw2-np` | [EKS Console](https://us-west-2.console.aws.amazon.com/eks/home?region=us-west-2#/clusters/opsera-usw2-np) |
          | ğŸ”„ ArgoCD | GitOps Controller | [ArgoCD Dashboard](https://argocd.agent.opsera.dev) |

          EOF

      - name: Promotion Flow
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          ## ğŸš€ Promotion Flow

          ```mermaid
          flowchart LR
              DEV["ğŸ”§ DEV<br/>Auto-deploy on push"]
              QA["ğŸ§ª QA<br/>Manual trigger<br/>ğŸ¤ Canary 10â†’30â†’60â†’100%"]
              STG["ğŸ­ STAGING<br/>Approval required<br/>ğŸ”µğŸŸ¢ Blue-Green"]
              PROD["ğŸ­ PRODUCTION<br/>Coming Soon"]

              DEV -->|"promote"| QA -->|"approve"| STG -.->|"future"| PROD
          ```

          EOF

      - name: Report Footer
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          ---

          <div align="center">

          **Powered by [Opsera](https://opsera.io)** - The Unified DevOps Platform

          ğŸ“… Generated: $(date -u +'%Y-%m-%d %H:%M UTC') | [ğŸ”„ Refresh](https://github.com/${{ env.GITHUB_REPO }}/actions/workflows/deployment-landscape-voting01.yaml)

          </div>
          EOF

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # NOTIFY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  notify:
    name: "ğŸ“¢ Notify"
    needs: [generate-report]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Slack Notification
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "Slack webhook not configured, skipping notification"
            exit 0
          fi
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "text": "ğŸ“Š Deployment Landscape Report Updated",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸ“Š *Deployment Landscape Report* has been updated for `voting01`\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Full Report>"
                  }
                }
              ]
            }' || true
