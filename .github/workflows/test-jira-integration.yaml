# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TEST JIRA INTEGRATION
# Standalone test to verify Jira ticket creation works
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸ§ª Test Jira Integration"

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of Jira ticket to create'
        type: choice
        options: ['security-vulnerability', 'deployment-failure', 'test-ticket']
        default: 'test-ticket'
      jira_url_override:
        description: 'Override JIRA_BASE_URL (leave empty to use secret)'
        type: string
        default: ''
      api_version:
        description: 'Jira API version'
        type: choice
        options: ['2', '3']
        default: '2'
      auth_type:
        description: 'Authentication type'
        type: choice
        options: ['basic', 'api-key']
        default: 'basic'

jobs:
  test-jira:
    name: "ðŸ“‹ Test Jira"
    runs-on: ubuntu-latest
    steps:
      - name: Check Jira Configuration
        id: check-jira
        run: |
          echo "### ðŸ” Jira Configuration Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          CONFIGURED="true"
          MISSING=""

          if [ -z "${{ secrets.JIRA_API_TOKEN }}" ]; then
            CONFIGURED="false"
            MISSING="${MISSING} JIRA_API_TOKEN"
            echo "âŒ JIRA_API_TOKEN: Not configured" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… JIRA_API_TOKEN: Configured" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -z "${{ secrets.JIRA_EMAIL }}" ]; then
            CONFIGURED="false"
            MISSING="${MISSING} JIRA_EMAIL"
            echo "âŒ JIRA_EMAIL: Not configured" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… JIRA_EMAIL: Configured" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -z "${{ secrets.JIRA_BASE_URL }}" ]; then
            CONFIGURED="false"
            MISSING="${MISSING} JIRA_BASE_URL"
            echo "âŒ JIRA_BASE_URL: Not configured" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… JIRA_BASE_URL: Configured" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "configured=${CONFIGURED}" >> $GITHUB_OUTPUT

          if [ "$CONFIGURED" = "false" ]; then
            echo "âš ï¸ **Missing secrets:**${MISSING}" >> $GITHUB_STEP_SUMMARY
            echo "Please configure the missing secrets in repository settings." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Test Jira API Connection
        if: steps.check-jira.outputs.configured == 'true'
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_URL_SECRET: ${{ secrets.JIRA_BASE_URL }}
          JIRA_URL_OVERRIDE: ${{ github.event.inputs.jira_url_override }}
          API_VERSION: ${{ github.event.inputs.api_version }}
          AUTH_TYPE: ${{ github.event.inputs.auth_type }}
        run: |
          # Use override URL if provided, otherwise use secret
          if [ -n "$JIRA_URL_OVERRIDE" ]; then
            JIRA_BASE_URL="$JIRA_URL_OVERRIDE"
            echo "ðŸ”§ Using override URL" >> $GITHUB_STEP_SUMMARY
          else
            JIRA_BASE_URL="$JIRA_BASE_URL_SECRET"
          fi

          echo "### ðŸ”Œ Testing Jira API Connection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Set auth header based on auth type
          if [ "$AUTH_TYPE" = "api-key" ]; then
            AUTH_HEADER="X-API-Key: ${JIRA_API_TOKEN}"
            echo "**Auth Type:** API Key (X-API-Key header)" >> $GITHUB_STEP_SUMMARY
          else
            AUTH_HEADER="Authorization: Basic $(echo -n "${JIRA_EMAIL}:${JIRA_API_TOKEN}" | base64)"
            echo "**Auth Type:** Basic (email:token)" >> $GITHUB_STEP_SUMMARY
          fi

          # Show URL for debugging
          echo "**Target:** \`${JIRA_BASE_URL}\`" >> $GITHUB_STEP_SUMMARY
          echo "**API Version:** \`${API_VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Test API connection - try project list (more reliable for mock)
          API_URL="${JIRA_BASE_URL}/rest/api/${API_VERSION}/project"
          echo "Making API call to ${API_URL}"

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "${AUTH_HEADER}" \
            -H "Content-Type: application/json" \
            "${API_URL}" 2>&1)

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Code: $HTTP_CODE"
          echo "Response Body: $BODY"

          echo "**HTTP Code:** \`$HTTP_CODE\`" >> $GITHUB_STEP_SUMMARY

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… **API Connection:** Success (HTTP $HTTP_CODE)" >> $GITHUB_STEP_SUMMARY
            PROJECT_COUNT=$(echo "$BODY" | jq 'length' 2>/dev/null || echo "0")
            echo "- Projects found: $PROJECT_COUNT" >> $GITHUB_STEP_SUMMARY
            # Export for next steps
            echo "JIRA_BASE_URL=${JIRA_BASE_URL}" >> $GITHUB_ENV
            echo "AUTH_HEADER=${AUTH_HEADER}" >> $GITHUB_ENV
          else
            echo "âŒ **API Connection:** Failed (HTTP $HTTP_CODE)" >> $GITHUB_STEP_SUMMARY
            echo "Response: $BODY" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: List Available Projects
        if: steps.check-jira.outputs.configured == 'true'
        env:
          API_VERSION: ${{ github.event.inputs.api_version }}
        run: |
          echo "### ðŸ“ Available Jira Projects" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          RESPONSE=$(curl -s \
            -H "${AUTH_HEADER}" \
            -H "Content-Type: application/json" \
            "${JIRA_BASE_URL}/rest/api/${API_VERSION}/project")

          echo "| Key | Name |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|------|" >> $GITHUB_STEP_SUMMARY
          echo "$RESPONSE" | jq -r '.[] | "| \(.key) | \(.name) |"' >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "| - | No projects found |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Save first project key for testing
          FIRST_PROJECT=$(echo "$RESPONSE" | jq -r '.[0].key // "DEPLOY"')
          echo "first_project=${FIRST_PROJECT}" >> $GITHUB_OUTPUT

      - name: Create Test Jira Ticket
        if: steps.check-jira.outputs.configured == 'true'
        id: create-ticket
        env:
          API_VERSION: ${{ github.event.inputs.api_version }}
        run: |
          echo "### ðŸ“ Creating Test Jira Ticket" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          TEST_TYPE="${{ github.event.inputs.test_type }}"
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M UTC')

          case "$TEST_TYPE" in
            "security-vulnerability")
              SUMMARY="[TEST-SECURITY] voting01-dev: 3 Critical, 5 High vulnerabilities"
              DESCRIPTION="Test security vulnerability ticket from CI/CD pipeline.\n\nThis is a test to verify Jira integration for security scan findings.\n\nTest Details:\n- Timestamp: ${TIMESTAMP}\n- Workflow: ${{ github.workflow }}\n- Run ID: ${{ github.run_id }}\n- GitHub: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              PRIORITY="High"
              ;;
            "deployment-failure")
              SUMMARY="[TEST-DEPLOY] voting01-dev Deployment Failed"
              DESCRIPTION="Test deployment failure ticket from CI/CD pipeline.\n\nThis is a test to verify Jira integration for deployment failures.\n\nTest Details:\n- Timestamp: ${TIMESTAMP}\n- Workflow: ${{ github.workflow }}\n- Run ID: ${{ github.run_id }}\n- GitHub: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              PRIORITY="High"
              ;;
            *)
              SUMMARY="[TEST] Jira Integration Test - ${TIMESTAMP}"
              DESCRIPTION="Test ticket to verify Jira integration is working correctly.\n\nTest Details:\n- Timestamp: ${TIMESTAMP}\n- Triggered by: ${{ github.actor }}\n- Workflow: ${{ github.workflow }}\n- Run ID: ${{ github.run_id }}\n- Repository: ${{ github.repository }}\n- GitHub: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              PRIORITY="Medium"
              ;;
          esac

          # Try DEPLOY project first, fallback to first available
          PROJECT_KEY="DEPLOY"

          # API v2 uses plain text description, v3 uses ADF format
          if [ "$API_VERSION" = "2" ]; then
            PAYLOAD="{
              \"fields\": {
                \"project\": {\"key\": \"${PROJECT_KEY}\"},
                \"summary\": \"${SUMMARY}\",
                \"description\": \"${DESCRIPTION}\",
                \"issuetype\": {\"name\": \"Task\"},
                \"priority\": {\"name\": \"${PRIORITY}\"}
              }
            }"
          else
            PAYLOAD="{
              \"fields\": {
                \"project\": {\"key\": \"${PROJECT_KEY}\"},
                \"summary\": \"${SUMMARY}\",
                \"description\": {
                  \"type\": \"doc\",
                  \"version\": 1,
                  \"content\": [
                    {
                      \"type\": \"paragraph\",
                      \"content\": [
                        {\"type\": \"text\", \"text\": \"${DESCRIPTION}\"}
                      ]
                    }
                  ]
                },
                \"issuetype\": {\"name\": \"Bug\"},
                \"priority\": {\"name\": \"${PRIORITY}\"}
              }
            }"
          fi

          echo "Creating ticket with API v${API_VERSION}..."

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "${AUTH_HEADER}" \
            -H "Content-Type: application/json" \
            "${JIRA_BASE_URL}/rest/api/${API_VERSION}/issue" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          ISSUE_KEY=$(echo "$BODY" | jq -r '.key // "FAILED"')
          ISSUE_ID=$(echo "$BODY" | jq -r '.id // "FAILED"')

          if [ "$ISSUE_KEY" != "FAILED" ] && [ "$ISSUE_KEY" != "null" ] && [ "$HTTP_CODE" = "201" ]; then
            ISSUE_URL="${JIRA_BASE_URL}/browse/${ISSUE_KEY}"
            echo "âœ… **Ticket Created Successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Issue Key | [${ISSUE_KEY}](${ISSUE_URL}) |" >> $GITHUB_STEP_SUMMARY
            echo "| Issue ID | ${ISSUE_ID} |" >> $GITHUB_STEP_SUMMARY
            echo "| Type | ${TEST_TYPE} |" >> $GITHUB_STEP_SUMMARY
            echo "| Priority | ${PRIORITY} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— **[Open Ticket in Jira](${ISSUE_URL})**" >> $GITHUB_STEP_SUMMARY

            echo "issue_key=${ISSUE_KEY}" >> $GITHUB_OUTPUT
            echo "issue_url=${ISSUE_URL}" >> $GITHUB_OUTPUT
          else
            echo "âŒ **Failed to create ticket** (HTTP $HTTP_CODE)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Error Response:**" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo "$BODY" | jq '.' >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "$BODY" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-jira.outputs.configured }}" != "true" ]; then
            echo "âŒ **Result:** Jira secrets not configured" >> $GITHUB_STEP_SUMMARY
          elif [ -n "${{ steps.create-ticket.outputs.issue_key }}" ]; then
            echo "âœ… **Result:** Jira integration working!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The CI/CD pipeline can now create Jira tickets for:" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”’ Security vulnerability findings" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸš« Deployment failures" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Result:** Jira ticket creation failed" >> $GITHUB_STEP_SUMMARY
          fi
