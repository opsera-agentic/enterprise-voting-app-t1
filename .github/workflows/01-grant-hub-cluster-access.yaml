# Grant Hub Cluster Access to GitHub Actions Role
# This workflow adds the voting2 GitHub Actions IAM role to the ArgoCD hub cluster's aws-auth ConfigMap
#
# Prerequisites: Must be run by someone with existing hub cluster access
# This is a ONE-TIME setup - run once after bootstrap
#
# Generated by Opsera Code-to-Cloud v0.6

name: "01-Grant Hub Cluster Access"

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform"
        required: true
        default: "preview"
        type: choice
        options:
          - preview
          - apply

env:
  AWS_REGION: us-west-2
  HUB_CLUSTER: argocd-usw2
  APP_NAME: voting2
  ENVIRONMENT: dev

permissions:
  id-token: write
  contents: read

jobs:
  grant-access:
    name: "Grant Hub Cluster Access"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # Use a role that ALREADY has hub cluster access
          # This could be a central admin role or opsera-github-actions role
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/opsera-github-actions
          role-session-name: github-actions-grant-access-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Update kubeconfig for Hub Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          echo "Connected to hub cluster: ${{ env.HUB_CLUSTER }}"
          kubectl cluster-info

      - name: Get Current aws-auth ConfigMap
        run: |
          echo "## Current aws-auth ConfigMap" >> $GITHUB_STEP_SUMMARY
          echo '```yaml' >> $GITHUB_STEP_SUMMARY
          kubectl get configmap aws-auth -n kube-system -o yaml >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Preview aws-auth Update
        if: github.event.inputs.action == 'preview'
        run: |
          ROLE_ARN="arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}-github-actions"

          echo "## Role to Add" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following IAM role will be granted access to the hub cluster:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```yaml' >> $GITHUB_STEP_SUMMARY
          echo "- rolearn: ${ROLE_ARN}" >> $GITHUB_STEP_SUMMARY
          echo "  username: github-actions-${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "  groups:" >> $GITHUB_STEP_SUMMARY
          echo "    - system:masters" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To apply this change, re-run this workflow with action: apply**" >> $GITHUB_STEP_SUMMARY

      - name: Apply aws-auth Update
        if: github.event.inputs.action == 'apply'
        run: |
          ROLE_ARN="arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}-github-actions"
          USERNAME="github-actions-${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"

          # Check if role already exists in aws-auth
          if kubectl get configmap aws-auth -n kube-system -o yaml | grep -q "${ROLE_ARN}"; then
            echo "Role already exists in aws-auth ConfigMap"
            echo "## Status: Already Configured" >> $GITHUB_STEP_SUMMARY
            echo "The role \`${ROLE_ARN}\` is already in aws-auth." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Use eksctl to add the role (safer than manual patching)
          echo "Adding role to aws-auth ConfigMap..."

          # Create a patch file
          cat > /tmp/aws-auth-patch.yaml << EOF
          data:
            mapRoles: |
              $(kubectl get configmap aws-auth -n kube-system -o jsonpath='{.data.mapRoles}')
              - rolearn: ${ROLE_ARN}
                username: ${USERNAME}
                groups:
                  - system:masters
          EOF

          # Apply the patch using kubectl
          kubectl patch configmap aws-auth -n kube-system --patch-file /tmp/aws-auth-patch.yaml

          echo "## Status: Access Granted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Successfully added role to aws-auth ConfigMap:" >> $GITHUB_STEP_SUMMARY
          echo "- **Role ARN**: \`${ROLE_ARN}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Username**: \`${USERNAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Groups**: \`system:masters\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The voting2 GitHub Actions workflows can now access the hub cluster." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Step**: Re-run the \`00-Bootstrap Infrastructure\` workflow to set up ArgoCD." >> $GITHUB_STEP_SUMMARY

      - name: Verify Access (Apply only)
        if: github.event.inputs.action == 'apply'
        run: |
          echo ""
          echo "Updated aws-auth ConfigMap:"
          kubectl get configmap aws-auth -n kube-system -o yaml
