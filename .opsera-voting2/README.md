# Voting2 - Code-to-Cloud Deployment

Generated by **Opsera Code-to-Cloud v0.6**

## Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              AWS Cloud (us-west-2)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│  │   ECR           │    │   RDS           │    │   ElastiCache   │         │
│  │   Repositories  │    │   PostgreSQL    │    │   Redis         │         │
│  │   - vote        │    │   (IAM Auth)    │    │                 │         │
│  │   - result      │    │                 │    │                 │         │
│  │   - worker      │    │                 │    │                 │         │
│  └────────┬────────┘    └────────┬────────┘    └────────┬────────┘         │
│           │                      │                      │                   │
│  ┌────────┴──────────────────────┴──────────────────────┴────────┐         │
│  │                        VPC (opsera-vpc)                        │         │
│  │  ┌─────────────────────────────────────────────────────────┐  │         │
│  │  │              EKS Cluster (opsera-usw2-np)                │  │         │
│  │  │  ┌─────────────────────────────────────────────────────┐│  │         │
│  │  │  │              Namespace: voting2-dev                 ││  │         │
│  │  │  │  ┌───────────┐ ┌───────────┐ ┌───────────┐         ││  │         │
│  │  │  │  │   vote    │ │  result   │ │  worker   │         ││  │         │
│  │  │  │  │  (Python) │ │ (Node.js) │ │  (.NET)   │         ││  │         │
│  │  │  │  │   IRSA    │ │   IRSA    │ │   IRSA    │         ││  │         │
│  │  │  │  └─────┬─────┘ └─────┬─────┘ └─────┬─────┘         ││  │         │
│  │  │  │        │             │             │                ││  │         │
│  │  │  │  ┌─────┴─────────────┴─────────────┴─────┐         ││  │         │
│  │  │  │  │         NGINX Ingress Controller      │         ││  │         │
│  │  │  │  └───────────────────┬───────────────────┘         ││  │         │
│  │  │  └──────────────────────┼──────────────────────────────┘│  │         │
│  │  └─────────────────────────┼───────────────────────────────┘  │         │
│  └────────────────────────────┼──────────────────────────────────┘         │
│                               │                                             │
└───────────────────────────────┼─────────────────────────────────────────────┘
                                │
                    ┌───────────┴───────────┐
                    │   Let's Encrypt TLS   │
                    │   (cert-manager)      │
                    └───────────┬───────────┘
                                │
            ┌───────────────────┼───────────────────┐
            │                   │                   │
   vote-voting2-dev.    result-voting2-dev.
   agent.opsera.dev     agent.opsera.dev
```

## Security Configuration (IRSA - No Hardcoded Credentials)

| Authentication | Method | Description |
|----------------|--------|-------------|
| GitHub Actions → AWS | OIDC | No access keys, federated identity |
| Pods → AWS Resources | IRSA | IAM Roles for Service Accounts |
| Apps → RDS PostgreSQL | IAM Auth | Token-based, no passwords |
| Apps → ElastiCache | VPC | Network-level security |

## Prerequisites

Before deploying, ensure you have:

1. **AWS CLI** configured with admin access (for one-time bootstrap)
2. **Existing infrastructure**:
   - VPC named `opsera-vpc`
   - EKS cluster named `opsera-usw2-np`
   - ArgoCD installed on hub cluster `argocd-usw2`
   - Spoke cluster registered in ArgoCD

## Quick Start

### Step 1: Setup Terraform Backend (One-time)

```bash
cd .opsera-voting2/scripts
./setup-terraform-backend.sh
```

### Step 2: Bootstrap GitHub Actions IAM Role (One-time)

```bash
cd .opsera-voting2/scripts
./bootstrap-iam-role.sh
```

### Step 3: Add GitHub Secret

Go to your repository settings and add:
- **Name**: `AWS_ACCOUNT_ID`
- **Value**: Your 12-digit AWS account ID

### Step 4: Run Bootstrap Workflow

1. Go to GitHub Actions
2. Select "00-Bootstrap Infrastructure"
3. Click "Run workflow"
4. Select action: `apply`
5. Click "Run workflow"

This creates:
- ECR repositories
- RDS PostgreSQL (with IAM auth)
- ElastiCache Redis
- IRSA roles for pods
- ArgoCD application

### Step 5: Build and Deploy

Either:
- Push code to `main` branch (auto-triggers)
- Or run "20-CI Build & Push" workflow manually

## File Structure

```
.opsera-voting2/
├── README.md                    # This file
├── skill-manifest.yaml          # Deployment configuration
├── Dockerfiles/
│   ├── Dockerfile.vote          # Python Flask app
│   ├── Dockerfile.result        # Node.js app
│   └── Dockerfile.worker        # .NET worker
├── terraform/
│   ├── main.tf                  # ECR, RDS, ElastiCache, IRSA
│   ├── variables.tf             # Input variables
│   ├── outputs.tf               # Output values
│   └── dev.tfvars               # Dev environment values
├── k8s/
│   ├── base/
│   │   ├── namespace.yaml
│   │   ├── configmap.yaml       # Database endpoints (populated by TF)
│   │   ├── serviceaccounts.yaml # IRSA annotations (populated by TF)
│   │   ├── vote-deployment.yaml
│   │   ├── result-deployment.yaml
│   │   ├── worker-deployment.yaml
│   │   ├── vote-service.yaml
│   │   ├── result-service.yaml
│   │   ├── ingress.yaml         # NGINX + cert-manager
│   │   └── kustomization.yaml
│   └── overlays/
│       └── dev/
│           ├── kustomization.yaml
│           ├── patch-replicas.yaml
│           └── patch-ingress.yaml
├── argocd/
│   └── application.yaml         # Hub-spoke ArgoCD app
└── scripts/
    ├── bootstrap-iam-role.sh    # Create GitHub OIDC role
    └── setup-terraform-backend.sh # Create S3/DynamoDB
```

## Endpoints

After successful deployment:

| Service | URL |
|---------|-----|
| Vote | https://vote-voting2-dev.agent.opsera.dev |
| Result | https://result-voting2-dev.agent.opsera.dev |

## Troubleshooting

### OIDC Authentication Fails

```bash
# Verify the role exists
aws iam get-role --role-name voting2-dev-github-actions

# Check trust policy
aws iam get-role --role-name voting2-dev-github-actions --query 'Role.AssumeRolePolicyDocument'
```

### Pods Can't Connect to RDS

```bash
# Check ServiceAccount has IRSA annotation
kubectl get sa -n voting2-dev -o yaml

# Verify IAM role ARN matches
kubectl describe sa result -n voting2-dev
```

### ArgoCD Sync Fails

```bash
# Check if spoke cluster is registered
argocd cluster list

# Check application status
argocd app get voting2-dev
```

## Cost Estimate (Dev Environment)

| Resource | Type | Estimated Monthly Cost |
|----------|------|------------------------|
| RDS PostgreSQL | db.t3.micro | ~$15 |
| ElastiCache Redis | cache.t3.micro | ~$12 |
| ECR Storage | 10GB | ~$1 |
| **Total** | | **~$28/month** |

---

*Generated by Opsera Code-to-Cloud v0.6 | Powered by Opsera*
